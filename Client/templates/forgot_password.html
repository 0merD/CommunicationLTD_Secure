{% extends "base.html" %}

{% block title %}Forgot Password - Communication LTD{% endblock %}

{% block content %}
<div class="auth-card">
    <div class="card-header text-center">
        <i class="bi bi-question-circle fs-2 mb-3 text-primary"></i>
        <h3>Forgot Your Password?</h3>
        <p class="mb-0 opacity-75">We will send you a reset code by email</p>
    </div>

    <div class="card-body">
        <!-- Info alert -->
        <div class="alert alert-info w-50 mx-auto">
            <i class="bi bi-info-circle"></i>
            <strong>How it works:</strong>
            <ol class="mb-0 mt-2">
                <li>Enter your registered email address</li>
                <li>We’ll send you a secure reset code</li>
                <li>Use the code to create a new password</li>
            </ol>
        </div>

        <!-- Forgot Password Form -->
        <form method="POST" action="/forgot-password" class="d-flex flex-column align-items-center">
            <div class="mb-4 w-50">
                <label for="email" class="form-label">Email Address</label>
                <div class="position-relative">
                    <input type="email" class="form-control" id="email" name="email" required
                           placeholder="Enter your email address"
                           value="{{ request.form.email if request.form.email }}"
                           {% if code_verified %}disabled{% endif %}>
                    <i class="bi bi-envelope position-absolute end-0 top-50 translate-middle-y me-3 text-muted"></i>
                </div>
                <div class="form-text">
                    <i class="bi bi-shield-check"></i>
                    The reset code will be sent to the email registered in the system
                </div>
            </div>

            <div class="d-grid gap-2 w-50 mb-3">
                <button type="submit" class="btn btn-primary"
                        {% if code_verified %}disabled{% endif %}>
                    <i class="bi bi-send"></i> Send Reset Code
                </button>
            </div>
        </form>

        <!-- Verify Reset Code Form -->
        <form method="POST" action="/reset-password" class="d-flex flex-column align-items-center">
            <div class="mb-4 w-50">
                <label for="reset_code" class="form-label">Enter Reset Code</label>
                <div class="position-relative">
                    <input type="text" class="form-control" id="reset_code" name="reset_code" required
                           placeholder="Enter the code you received"
                           {% if code_verified %}disabled value="✔ Verified"{% endif %}>
                    <i class="bi bi-key position-absolute end-0 top-50 translate-middle-y me-3 text-muted"></i>
                </div>
            </div>

            <div class="d-grid gap-2 w-50 mb-3">
                <button type="submit" class="btn btn-success"
                        {% if code_verified %}disabled{% endif %}>
                    <i class="bi bi-check-circle"></i> Verify
                </button>
            </div>
        </form>

        <!-- Show new password form ONLY if reset code is verified -->
        {% if code_verified %}
        <form method="POST" action="/reset-password" class="d-flex flex-column align-items-center w-50 mx-auto">
            <div class="password-requirements mb-4">
                <h6><i class="bi bi-shield-check"></i> New password requirements:</h6>
                <ul>
                    <li>Please contact your IT representative</li>
                    <li>for up-to-date password limitations</li>
                </ul>
            </div>

            <!-- New password -->
            <div class="mb-3 w-100">
                <label for="new_password" class="form-label">New Password</label>
                <div class="position-relative">
                    <input type="password" class="form-control" id="new_password" name="new_password" required
                           placeholder="Enter a new password">
                    <button type="button" class="btn btn-sm position-absolute end-0 top-50 translate-middle-y me-2"
                            onclick="togglePassword('new_password')" style="border: none; background: none;">
                        <i class="bi bi-eye text-muted" id="new_password-icon"></i>
                    </button>
                </div>
            </div>

            <!-- Confirm password -->
            <div class="mb-4 w-100">
                <label for="confirm_password" class="form-label">Confirm New Password</label>
                <div class="position-relative">
                    <input type="password" class="form-control" id="confirm_password" name="confirm_password" required
                           placeholder="Re-enter the new password">
                    <button type="button" class="btn btn-sm position-absolute end-0 top-50 translate-middle-y me-2"
                            onclick="togglePassword('confirm_password')" style="border: none; background: none;">
                        <i class="bi bi-eye text-muted" id="confirm_password-icon"></i>
                    </button>
                </div>
            </div>

            <div class="d-flex gap-3 w-100">
                <button type="submit" class="btn btn-primary flex-fill">
                    <i class="bi bi-check-lg"></i> Update Password
                </button>
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary flex-fill">
                    <i class="bi bi-arrow-left"></i> Cancel
                </a>
            </div>
        </form>
        {% endif %}

        <!-- Links -->
       <div class="text-center">
            <hr class="my-4">
            <div class="d-flex justify-content-center mx-auto gap-2">
                <a href="{{ url_for('login_form') }}" class="btn btn-outline-secondary w-50">
                    <i class="bi bi-arrow-left"></i> Back to Login
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
